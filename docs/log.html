<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<title>ELF を吐く C コンパイラを Rui 本の方式で作る</title>
	<meta name="viewport" content="width=device-width">
<style>
		img.icon {
			border-radius: 50%;
		}
		div.one_person {
			display: flex;
			padding-bottom: 10px;
		}
		blockquote {
			position: relative;
			border-left: 3px solid #005242;
			padding-left: 10px;
			margin-inline-start: 10px;
			white-space: pre-wrap;
		}
		a {
			overflow-wrap: anywhere;
		}
		h3 {
			margin-top: 15px;
		}
		.name a {
			text-decoration: none;
			color: inherit;
		}
		.name a:hover {
			text-decoration: underline;
		}
		div.name_and_content {
			padding-left: 10px;
		}
		pre {
			white-space: pre-wrap;
		}
		body {
			text-size-adjust: 100%;
			-webkit-text-size-adjust: 100%;
		}
	</style>
	<link rel="stylesheet" href="vs.min.css">
	<script src="highlight.min.js"></script>
	<script>hljs.highlightAll();</script>
</head>
<body style="background-color: #eeeeee">
<h1>ELF を吐く C コンパイラを Rui 本の方式で作る</h1>
<p>編纂者：<a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></p>
<p><a href="https://github.com/sozysozbot/c_to_elf_compiler">リポジトリへのリンク</a></p>
<p><a href="https://hsjoihs.hatenablog.com/entry/*****">はてなブログへのバックリンク (FIXME)</a></p>

<h2>会話ログ本体</h2><h3 class="date">2022年10月3日（Discord にて）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span>
		<div class="content">そういや C コンパイラやってないな。アセンブリ言語を機械語にするのに binutils のを使うのもどうなんだろと思ってたらそのまま数ヶ月経ってた</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span>
		<div class="content">いいですね。だったら、Rui 本の原則に則って、『step 1 からもう ELF バイナリへとコンパイルしちゃう』『常に実行形式をコンパイラが生成し続けられるようにする』というのでやってみませんか？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span>
		<div class="content">なるほど</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span>
		<div class="content">C → アセンブラのコンパイラをセルフホストしたあとにアセンブラとリンカと libc と書くのは既に ushitora_anqou がやってるけど、最初から ELF バイナリへとコンパイルしつづける形式で Rui 本を走ってる人を私は知らないので、やってみるとおもしろそう</div>
		<div class="content">教材書けとは言わんので、作業ログでもいいんで書いてみません？言語はどれでやるんです？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span>
		<div class="content">もちろん Rust</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span>
		<div class="content">じゃあ、step 1 は『return 3; するやつと return 42; するやつを gcc でコンパイルして ELF バイナリを吐いて、その差分を比較してどのバイトを置き換えるべきかを調べ、それを &#x60;include_bytes!()&#x60; する』という方針にするのがよさそう</div>
		<div class="content">なので、step 1 ではアセンブラもリンカもない。まあ、拡張していくと、機械語を直にいじるのがじきにきつくなるので、だんだんアセンブリ言語が育っていって、それは GNU のアセンブリ言語とそれなりに互換性があることが期待されるが、別にそれを目標にするわけではない。</div>
		<div class="content">という感じでやっていくとよさそう。今日はもう寝ます？</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer"><img alt="tkr" class="icon" src="icons/tkr.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/kgtkr" target="_blank" rel="noopener noreferrer">tkr</a></span>
		<div class="content">いま布団の中です</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span>
		<div class="content">ではでは、おやすみなさい〜</div>
	</div>
</div>
<h3 class="date">2022年10月3日（一人で作業）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span>
		<div class="content">じゃあ私が勝手に step 1 を実装するか。なんなら会話ログももうレンダリングできるようにしておこう</div>
		<div class="content">とりあえず docs フォルダを立てて、docs/dialog.txt に会話を書いて docs/ 内で node index.js したらログがレンダリングできるようにしておいた</div>
		<div class="content">このリポジトリに招待を飛ばしておいて、</div>
		<div class="content">Ubuntu の方にリポジトリをクローンし、cargo init し、議事録を書く。おや、npm が通らない。えっと <a href="https://stackoverflow.com/questions/67938486/after-installing-npm-on-wsl-ubuntu-20-04-i-get-the-message-usr-bin-env-bash" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/67938486/after-installing-npm-on-wsl-ubuntu-20-04-i-get-the-message-usr-bin-env-bash</a> に従ったら直った。</div>
		<div class="content">ちゃんと README.md も書いておこう。まあ日本語と英語で書いておくか。</div>
		<div class="content">もう step 1 は私がやってしまおう。experiment フォルダにファイルを用意して、</div>
		<div class="content">とりあえず Makefile はこんな感じでいいか</div>
		<pre><code class="language-Makefile">CFLAGS=-std=c17 -Wall -s

3: 3.c
42: 42.c

clean: 
	rm 3
	rm 42

.PHONY: clean
</code></pre>
		<div class="content">gcc が出力したファイルのサイズを数えると、</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ wc -c 3
13296 3
</code></pre>
		<div class="content">うーむ、デカい！</div>
		<div class="content">まあ、考えてみると、一応 gcc の出力をそのまま使う必要もないんだよな</div>
		<div class="content"> <a href="https://www.muppetlabs.com/~breadbox/software/tiny/teensy.html" target="_blank" rel="noopener noreferrer">https://www.muppetlabs.com/~breadbox/software/tiny/teensy.html</a> に頼って、もっと小さい実行形式を出力できるようなお膳立てをしてからじゃないと step 1 にふさわしくない気がする</div>
		<div class="content">というか、reproducible なビルドになるようにしないといけないんだよな</div>
		<div class="content">……よし、こうするか。</div>
		<div class="content"><ol><li>nasm かなんかで小さな .asm をコンパイルすることで、我々が目指すべき「動く小さい ELF バイナリ」を得る</li><li>それはそれとして、我々が作るのは C コンパイラなので、常に C 言語（のようなもの）を入力として取る</li></ol></div>
	</div>
</div>
<h3 class="date">2022年10月3日（yukata_yu との会話）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/yukata_yu" target="_blank" rel="noopener noreferrer"><img alt="ゆかたゆ" class="icon" src="icons/ゆかたゆ.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/yukata_yu" target="_blank" rel="noopener noreferrer">ゆかたゆ</a></span>
		<div class="content">-O1 を使わないのですか？ (エイリアスなんでしたっけ)</div>
		<div class="content">あー， -Osがあるんだ…</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span>
		<div class="content">-O1 を導入せず、gcc を消し飛ばして nasm で作るようにします</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/yukata_yu" target="_blank" rel="noopener noreferrer"><img alt="ゆかたゆ" class="icon" src="icons/ゆかたゆ.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/yukata_yu" target="_blank" rel="noopener noreferrer">ゆかたゆ</a></span>
		<div class="content">なるほ</div>
	</div>
</div>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span>
		<div class="content">-Os を使うと、3 + 4 - 2 とかが畳み込まれちゃう気がするので</div>
		<div class="content">まあ一応 -Os でどれくらい減るのかも実験しておくか。そもそも nasm にする予定だけど。CFLAGS=-std=c17 -Wall -s -Os で試すと、</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make 3
cc -std=c17 -Wall -s -Os    3.c   -o 3
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make 42
cc -std=c17 -Wall -s -Os    42.c   -o 42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ wc -c 3
14328 3
</code></pre>
		<div class="content">はい、ということで nasm 使います</div>
	</div>
</div>
<h3 class="date">2022年10月3日（一人で作業）</h3>
<div class="one_person">
	<div><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer"><img alt="hsjoihs" class="icon" src="icons/hsjoihs.webp" height="48px"></a></div>
	<div class="name_and_content">
		<span class="name"><a href="https://twitter.com/hsjoihs" target="_blank" rel="noopener noreferrer">hsjoihs</a></span>
		<div class="content">とりあえず、原典にこうあるけど、</div>
		<pre><code class="language-x86asm">  ; tiny.asm
  BITS 32
  GLOBAL _start
  SECTION .text
  _start:
                mov     eax, 1
                mov     ebx, 42  
                int     0x80
</code></pre>
		<div class="content">64 ビット環境だし、この BITS 32 を削って実行してみるか。Makefile はこんな感じ</div>
		<pre><code class="language-Makefile">tiny42: tiny42.asm
	nasm -f elf tiny42.asm
	gcc -Wall -s -nostdlib tiny42.o -o tiny42
</code></pre>
		<div class="content">make tiny42 をすると～？</div>
		<pre><code class="language-shell">nasm -f elf tiny42.asm
gcc -Wall -s -nostdlib tiny42.o -o tiny42
/usr/bin/ld: i386 architecture of input file &#x60;tiny42.o&#x27; is incompatible with i386:x86-64 output
collect2: error: ld returned 1 exit status
make: *** [Makefile:12: tiny42] Error 1
</code></pre>
		<div class="content">はい。正直そんな気はしてた</div>
		<div class="content">普通に gcc 付属のアセンブラを使ってみるか</div>
		<pre><code class="language-x86asm">.globl _start
_start:
	movl	$1, %eax
	movl	$42, %ebx  
	int		$0x80
</code></pre>
		<div class="content">に対して</div>
		<pre><code class="language-Makefile">tiny42: tiny42.s
	gcc -Wall -s -nostdlib tiny42.s -o tiny42
</code></pre>
		<div class="content">をかませてやると、まあちゃんと動く。しかし wc -c tiny42 すると 13024 tiny42 なので、結局問題が解決してないんだよな</div>
		<div class="content">食事から戻った。やっていき</div>
		<div class="content"><a href="https://cs.lmu.edu/~ray/notes/nasmtutorial/" target="_blank" rel="noopener noreferrer">https://cs.lmu.edu/~ray/notes/nasmtutorial/</a> 曰く、</div>
		<pre><code class="language-">nasm -felf64 hello.asm &amp;&amp; ld hello.o &amp;&amp; ./a.out
</code></pre>
		<div class="content">でよいとのこと。なるほど、やってみるか</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make tiny42
nasm -felf64 tiny42.asm
ld tiny42.o -o tiny42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ ./tiny42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ echo $?
42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ wc -c tiny42
4672 tiny42
</code></pre>
		<div class="content">まあこんなもんか。これ以上削るのはやりすぎな気もする</div>
		<div class="content">一応マニュアル <a href="https://www.nasm.us/doc/" target="_blank" rel="noopener noreferrer">https://www.nasm.us/doc/</a> を見る。あ、--reproducible があるのか、都合がいい、つけておこう</div>
		<div class="content">おや、動かない。このバージョンの nasm にはないのかな</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ nasm --version
NASM version 2.14.02
</code></pre>
		<div class="content">マニュアルは version 2.15.05 となっている。この --reproducible、なんと version 2.15.05 で加わった最新の機能だそうだ。すばらしい</div>
		<div class="content">手元の WSL 2 上の Ubuntu でも sudo apt-get update からの sudo apt-get -y install nasm をすれば nasm が最新になってくれたりしないかな</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ sudo apt-get -y install nasm
Reading package lists... Done
Building dependency tree       
Reading state information... Done
nasm is already the newest version (2.14.02-1).
The following package was automatically installed and is no longer required:
  libfwupdplugin1
Use &#x27;sudo apt autoremove&#x27; to remove it.
0 upgraded, 0 newly installed, 0 to remove and 44 not upgraded.
</code></pre>
		<div class="content">残念。じゃあ自分で入れるしかないか</div>
		<div class="content">とりあえず <a href="https://www.linuxfromscratch.org/blfs/view/svn/general/nasm.html" target="_blank" rel="noopener noreferrer">https://www.linuxfromscratch.org/blfs/view/svn/general/nasm.html</a> に従って入れて……</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ nasm --version
NASM version 2.15.05 compiled on Oct  3 2022
</code></pre>
		<div class="content">よし。ではいよいよ</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make tiny42
nasm -felf64  --reproducible tiny42.asm
ld tiny42.o -o tiny42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make tiny3
nasm -felf64  --reproducible tiny3.asm
ld tiny3.o -o tiny3
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ ./tiny42; echo $?
42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ ./tiny3; echo $?
3
</code></pre>
		<div class="content">これは、やったか？</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ cmp -l ./tiny42 ./tiny3
4103  52   3
4185  21  20
4209  14  13
4233  30  27
4257  37  36
4286  64  63
4287  62  56
4288  56 141
4289 141 163
4290 163 155
4291 155   0
4292   0 137
4294 137 142
4295 142 163
4297 163 137
4298 137 163
4299 163 164
4300 164 141
4301 141 162
4302 162 164
4303 164   0
4304   0 137
4305 137 145
4306 145 144
4307 144 141
4308 141 164
4309 164 141
4310 141   0
4311   0 137
4312 137 145
4313 145 156
4314 156 144
4315 144   0
4317   0  56
4318  56 163
4319 163 171
4320 171 155
4321 155 164
4322 164 141
4323 141 142
4324 142   0
4325   0  56
4326  56 163
4327 163 164
4328 164 162
4329 162 164
4330 164 141
4331 141 142
4332 142   0
4333   0  56
4334  56 163
4335 163 150
4336 150 163
4337 163 164
4338 164 162
4339 162 164
4340 164 141
4341 141 142
4342 142   0
4343   0  56
4344  56 164
4345 164 145
4346 145 170
4347 170 164
4348 164   0
4577  44  43
4633 334 333
</code></pre>
		<div class="content">んー。ああそうか、ld 側にも reproducible にしてくれと頼まないと</div>
		<div class="content">……軽く調べたが、頼み方がよくわからん。リンカを gold にしたらバージョン名を埋め込んできたし。んー、1 バイトのズレはファイル名『tiny3.asm』『tiny42.asm』の差に起因してるっぽいし、そこを strip かなんかで処理すれば解決するかも？</div>
		<pre><code class="language-shell">hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make tiny42
nasm -felf64  --reproducible tiny42.asm
ld tiny42.o -o tiny42
strip tiny42
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ make tiny3
nasm -felf64  --reproducible tiny3.asm
ld tiny3.o -o tiny3
strip tiny3
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ ./tiny42; echo $?; ./tiny3; echo $?
42
3
hsjoihs@LAPTOP-BKHPSENK:~/c_to_elf_compiler/experiment$ cmp -l ./tiny42 ./tiny3
4103  52   3
</code></pre>
		<div class="content">よし、差分が 1 バイトになった！！！！！</div>
		<div class="content">ここで 52 って出てるのは cmp コマンドがバイトを 8 進数で出力する仕様になっているからであって、これは 10 進数だと 42 なのでこれで正解です</div>
		<div class="content">よーし、やっとスタート地点に立つことができた</div>
		<pre><code class="language-rust">fn main() -&gt; std::io::Result&lt;()&gt; {
    let input = std::env::args().nth(1).expect(&quot;入力が与えられていません&quot;);
    let input: u8 = input.parse().expect(&quot;入力をパースできません&quot;);
    let tiny_3 = include_bytes!(&quot;../experiment/tiny3&quot;);
    let tiny_42 = include_bytes!(&quot;../experiment/tiny42&quot;);
    assert_eq!(tiny_3.len(), tiny_42.len());

    let file = std::fs::File::create(&quot;a.out&quot;)?;

    {
        use std::io::Write;
        let mut writer = std::io::BufWriter::new(file);
        for (index, byte) in tiny_3.iter().enumerate() {
            if *byte == tiny_42[index] {
                writer.write_all(&amp;[*byte])?;
            } else if *byte == 3 &amp;&amp; tiny_42[index] == 42 {
                writer.write_all(&amp;[input])?;
            } else {
                panic!(&quot;&#x60;../experiment/tiny3&#x60; と &#x60;../experiment/tiny42&#x60; の間に非自明な差分が見つかったので、なにを出力すべきか分かりません&quot;)
            }
        }
    }
    Ok(())
}
</code></pre>
		<div class="content">これで、step 1 達成！</div>
	</div>
</div>

<div style="font-size: 70%; display: flex; justify-content: center;">
	<div>
		Powered by <a href="https://github.com/sozysozbot/PseudoRoku">PseudoRoku</a>, which is designed by <a href="https://twitter.com/hsjoihs">hsjoihs</a>. <a href="https://github.com/sozysozbot/PseudoRoku/issues">Feel free to report any issues</a>.
	</div>
</div></body>
